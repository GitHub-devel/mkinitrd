#!/bin/bash
#
# Build a mkinitrd source rpm 
#

DESTDIR="."
RPMDIR="mkinitrd-rpm"

while [ $# -gt 0 ] ; do
    case "$1" in
	-d)
	    DESTDIR=$2;
	    shift 2;
	    ;;
	--destdir)
	    DESTDIR=${$1#*=};
	    shift;
	    ;;
	-b)
	    BRANCH=$2;
	    shift 2;
	    ;;
	--branch=)
	    BRANCH=${1##*=};
	    shift;
	    ;;
	-p)
	    RPMDIR=$2;
	    shift 2;
	    ;;
	--prefix)
	    RPMDIR=${$1#*=};
	    shift;
	    ;;
	*)
	    echo "Usage: build_rpm [-f] [-d DIR|--destdir=DIR] [-b BRANCH|--branch=BRANCH] [-p DIR|--prefix=DIR]"
	    exit 1;
	    ;;
    esac
done

if [ -z "$BRANCH" ] ; then
    BRANCH="HEAD"
    echo "Branch is not set, using default $BRANCH"
fi

set -e
set -o pipefail
rm -rf "$DESTDIR/$RPMDIR"
mkdir -p "$DESTDIR/$RPMDIR"

git archive --format=tar --prefix=$RPMDIR/ "$BRANCH" \
    | (cd $DESTDIR && tar xf -)

rm $DESTDIR/$RPMDIR/build_rpm

echo "mkinitrd src rpm copied to $DESTDIR/$RPMDIR"
